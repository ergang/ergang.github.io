<!DOCTYPE html>
<html>

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, user-scalable=yes, initial-scale=1, maximum-scale=1">
  <meta name="mobile-web-app-capable" content="yes">

  <base target="_blank">

  <title>Web RTC POC</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/meyer-reset/2.0/reset.min.css" rel="stylesheet" />
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN"
    crossorigin="anonymous">

  <style>
    html * {
      font-family: "AvenirNext", "Avenir", "Helvetica Neue", "Helvetica";
      box-sizing: border-box;
    }

    body {
      padding: 10px;
    }

    /* .none {
      -webkit-filter: none;
      filter: none;
    }

    .blur {
      -webkit-filter: blur(3px);
      filter: blur(3px);
    }

    .grayscale {
      -webkit-filter: grayscale(1);
      filter: grayscale(1);
    }

    .invert {
      -webkit-filter: invert(1);
      filter: invert(1);
    }

    .sepia {
      -webkit-filter: sepia(1);
      filter: sepia(1);
    } */

    video {
      object-fit: cover;
      width: 100%;
    }

    canvas#snapshot {
      object-fit: cover;
      display: none;
      width: 100%;
      padding: 50px;
    }

    .takePhoto {
      width: 100%;
      background: #0077C5;
      border: #0077C5;
      border-radius: 4px;
      height: 44px;
      box-shadow: 0 1px 1px 0 rgba(0, 0, 0, .75);
      padding: 6px 12px;
      cursor: pointer;
      font-weight: 400;
      font-size: 18px;
      text-align: center;
      color: #FFF;
      display: inline-block;
      margin: 10px auto;
    }


    .fa-check {
      color: green;
    }

    h1 {
      font-size: 20px;
      font-weight: bold;
      width: 100%;
      text-align: center;
      padding: 10px 20px;
    }

    h2 {
      width: 100%;
      text-align: center;
    }

    #video_box {
      position: relative;
      float: left;
      border-radius: 5px;
      border: 4px solid #ccc;
      border-style: dashed;
      width: 100%;

      margin: 10px auto;
    }

    #video_overlays {
      position: absolute;
      float: left;
      width: 100%;
      background-color: transparent;
      z-index: 300000;
      margin: 10px auto;
    }

    ul {
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      width: 90%;
      text-align: center;
      margin: auto;
      padding: 10px 0;
    }

    li i {
      padding-right: 5px;
    }

    li {
      list-style: none;
      display: inline-block;
      width: calc(100% / 2);
      padding-left: 10px;
      padding: 10px;
      text-align: left;
    }

    h1#overlayInstructions {
      background: #0077C5;
      border-radius: 30px;
      color: white;
      opacity: 0.7;
      width: 60%;
      margin: auto;
    }

    .hidden {
      visibility: hidden;
      opacity: 0;
      transition: visibility 0s 2s, opacity 2s ease-in-out;
      -webkit-transition: visibility 0s 2s, opacity 2s ease-in-out;
    }
  </style>

</head>

<body>
  <div id="container">

    <h1>Take a photo of the front of your ID</h1>

    <h2>Be sure your photo has:</h2>

    <ul>
      <li>
        <i class="fa fa-check"></i>No shadows</li>
      <li>
        <i class="fa fa-check"></i>No glare</li>
      <li>
        <i class="fa fa-check"></i>No blur</li>
      <li>
        <i class="fa fa-check"></i>Dark background</li>
    </ul>

    <!-- Web RTC -->
    <div id="webRtcContainer">
      <div id="video_box">
        <div id="video_overlays">
          <h1 id="loadingLabel"> Loading camera ... </h1>
          <h1 id="overlayInstructions" style="display:none">Make sure it's focused ...</h1>
        </div>

        <video autoplay="true" playsinline="true">Your browser does not support streaming this content.</video>

      </div>

      <canvas id="snapshot"></canvas>

      <button class="takePhoto" id="snapshot">Take a photo</button>
    </div>

    <!-- File upload -->
    <div id="fileUploadContainer" style="display:none">
      <img id="dlImage" src="dl.jpg" width='100%' height='100%' >

      <label for="file-upload" class="takePhoto" id='fileUpload'>
        <span style="display:inline-block; margin-top:7px;">Take a photo</span>
      </label>
      <input id="file-upload" style="display:none" type="file" accept="image/*;capture=camera"/>
    </div>
  </div>

  <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>

  <script>
    'use strict';

    var snapshotButton = document.querySelector('button#snapshot');
    var loadingEl = document.querySelector('#loadingLabel');
    var overlayInstructions = document.querySelector('#overlayInstructions');

    // Put variables in global scope to make them available to the browser console.
    var video = window.video = document.querySelector('video');
    var canvas = window.canvas = document.querySelector('canvas');
    canvas.width = 640;
    canvas.height = 360;

    snapshotButton.onclick = function () {
      canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
      canvas.setAttribute('style', 'display: block');
      alert('Image size: ' + stringToBytesFaster(canvas.toDataURL()).length / 1000000 + " MB");
    };

    var constraints = {
      audio: false,
      video: true
    };

    var cameras = [];

    function handleSuccess(stream) {
      window.stream = stream; // make stream available to browser console
      video.srcObject = stream;
    }

    video.onloadeddata = () => {
      loadingEl.style.display = 'none';
      overlayInstructions.style.display = 'block';
      setTimeout(() => { overlayInstructions.className = 'hidden'; }, 1000);
    }

    function fileUploadMode() {
      var webRtcContainer = document.querySelector('#webRtcContainer');
      webRtcContainer.style.display = 'none';

      var fileUploadContainer = document.querySelector('#fileUploadContainer');
      fileUploadContainer.style.display = 'block';
    }

    function stringToBytesFaster(str) {
      //http://stackoverflow.com/questions/1240408/reading-bytes-from-a-javascript-string
      var ch, st, re = [], j = 0;
      for (var i = 0; i < str.length; i++) {
        ch = str.charCodeAt(i);
        if (ch < 127) {
          re[j++] = ch & 0xFF;
        }
        else {
          st = [];    // clear stack
          do {
            st.push(ch & 0xFF);  // push byte to stack
            ch = ch >> 8;          // shift value down by 1 byte
          }
          while (ch);
          // add stack contents to result
          // done because chars have "wrong" endianness
          st = st.reverse();
          for (var k = 0; k < st.length; ++k)
            re[j++] = st[k];
        }
      }
      // return an array of bytes
      return re;
    }

    function handleError(error) {
      console.log(error);
      fileUploadMode();
    }

    function gotDevices(deviceInfos) {
      for (var i = 0; i < deviceInfos.length; i++) {
        var deviceInfo = deviceInfos[i];

        if (deviceInfo.kind === 'videoinput') {
          cameras.push(deviceInfo);
        }
      }

      var cameraId = null;

      if (cameras.length > 0) {
        cameraId = cameras[0].deviceId;
      } else if (cameras.length > 1) {
        cameraId = cameras[1].deviceId;
      }

      // constraints.video = { 
      //   deviceId: cameraId ? { exact: cameraId } : undefined
      // };

      constraints.video = {
        facingMode: "environment",
        width: { ideal: 1280 },
        height: { ideal: 720 }
      }

      return navigator.mediaDevices.getUserMedia(constraints);
    }

    navigator.mediaDevices.enumerateDevices()
      .then(gotDevices)
      .then(handleSuccess)
      .catch(handleError);

  </script>
</body>

</html>